<html> 
<head> 
<script type="text/javascript" src="http://maps.google.ru/maps/api/js?libraries=geometry&sensor=false"></script> 
<script type="text/javascript" src="jquery-1.4.2.min.js"></script> 
<script type="text/javascript" src="monitoring.js"></script> 
<script type="text/javascript" src="monitoring-tools.js"></script> 
<script type="text/javascript" src="canvas.js"></script> 
<script type="text/javascript" src="canvas2.js"></script> 
<script type="text/javascript">

    
var str  = "";
var map;
var mapTypes = {};
var mapTypeIds = [];
var latlng = new google.maps.LatLng(40.367947, 68.464790);
var mon;
var reports;
var poi;
var ruler;
var myplace;
var geo;
var zoom = [9, 10, 11, 12, 13 ,14, 15, 16, 17];

function initialize() 
{
  
	mapTypes['googlemap'] =  google.maps.MapTypeId.ROADMAP;
	mapTypes['googlesat'] =  google.maps.MapTypeId.SATELLITE;
	for (var key in mapTypes) {
	  if (key == 'googlemap' || key == 'googlesat' )
	    mapTypeIds.push(mapTypes[key]);
		else
        mapTypeIds.push(key);
      }
    document.body.style.cursor = "default";
  
	//Set the center of the map
	var map_center = latlng;
	//Set the map properties
	var mapOptions = {
	     zoom: 10,
	     mapTypeId: google.maps.MapTypeId.ROADMAP,
	     MapTypeControl: true,
	     streetViewControl: false,
	     mapTypeControlOptions: {
	 					     mapTypeIds:mapTypeIds,
	 						style: google.maps.MapTypeControlStyle.DROPDOWN_MENU },
	     navigationControl: true,
	     navigationControlOptions: { style: google.maps.NavigationControlStyle.ZOOM_PAN },
	     backgroundColor: 'White',
	     scrollwheel: true,
	     maxZoom: 18,
	     minZoom: 0,
	     scaleControl: true,
	     center: map_center
    }
 
	map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
	map.setOptions({draggableCursor:'default'});
	google.maps.event.addListenerOnce(map, 'idle', function(){});
	google.maps.event.addListener(map, 'zoom_changed', function(){});
	for (key in mapTypes) {
		if (key == 'googlemap' || key == 'googlesat' ) continue;
		map.mapTypes.set(key, new google.maps.ImageMapType(mapTypes[key]));
	}
}

var tmpData= [];
var tmp = {};

function setMapMode(pos)
{
    tmpData.push(pos);
    if (mon == null || mon == 'undefined') {
        mon = new Monitoring(map);
    }
    
    MonitoringTools.MonitoringInit([]);	
    mon.obj_array(pos, true);	
}

    setInterval(
function setMarkerPos() {
    var login = 'newmax',
        groups = '1,2,3',
        fleet = '202',
        xhr = new XMLHttpRequest();

    xhr.open('POST', encodeURI('/positions'));
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.onload = function() {
            if (xhr.status === 200 ) {
                var jpos = JSON.parse(xhr.responseText);
                var positions = [];
                for(var i in jpos.Update){
                    positions.push(jpos.Update[i]);
                }
                setMapMode(positions);
            }
            else if (xhr.status !== 200) {
                console.log("http error");
            }
    };
    var params = { 
                    'user':login,
                    'groups':groups,
                    'selectedFleetJs': fleet
    }  
    xhr.send(JSON.stringify(params));
} , 3000);
</script>
</head> 
<body onload="initialize()">
  <div id="map_canvas" style="width:100%; height:100%"></div>
</body>
</html>
