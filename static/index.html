<html> 
<head> 
<script type="text/javascript" src="http://maps.google.ru/maps/api/js?libraries=geometry&sensor=false"></script> 
<script type="text/javascript" src="jquery-1.4.2.min.js"></script> 
<script type="text/javascript" src="monitoring.js"></script> 
<script type="text/javascript" src="monitoring-tools.js"></script> 
<script type="text/javascript" src="canvas.js"></script> 
<script type="text/javascript" src="canvas2.js"></script> 
<script type="text/javascript">

    
var str  = "";
var map;
var mapTypes = {};
var mapTypeIds = [];
var latlng = new google.maps.LatLng(40.367947, 68.464790);
var mon;
var reports;
var poi;
var ruler;
var myplace;
var geo;
var zoom = [9, 10, 11, 12, 13 ,14, 15, 16, 17];

function initialize() 
{
  
	mapTypes['googlemap'] =  google.maps.MapTypeId.ROADMAP;
	mapTypes['googlesat'] =  google.maps.MapTypeId.SATELLITE;
	for (var key in mapTypes) {
	  if (key == 'googlemap' || key == 'googlesat' )
	    mapTypeIds.push(mapTypes[key]);
		else
        mapTypeIds.push(key);
      }
    document.body.style.cursor = "default";
  
	//Set the center of the map
	var map_center = latlng;
	//Set the map properties
	var mapOptions = {
	     zoom: 10,
	     mapTypeId: google.maps.MapTypeId.ROADMAP,
	     MapTypeControl: true,
	     streetViewControl: false,
	     mapTypeControlOptions: {
	 					     mapTypeIds:mapTypeIds,
	 						style: google.maps.MapTypeControlStyle.DROPDOWN_MENU },
	     navigationControl: true,
	     navigationControlOptions: { style: google.maps.NavigationControlStyle.ZOOM_PAN },
	     backgroundColor: 'White',
	     scrollwheel: true,
	     maxZoom: 18,
	     minZoom: 0,
	     scaleControl: true,
	     center: map_center
    }
 
	map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
	map.setOptions({draggableCursor:'default'});
	google.maps.event.addListenerOnce(map, 'idle', function(){});
	google.maps.event.addListener(map, 'zoom_changed', function(){});
	for (key in mapTypes) {
		if (key == 'googlemap' || key == 'googlesat' ) continue;
		map.mapTypes.set(key, new google.maps.ImageMapType(mapTypes[key]));
	}
}

var tmpData= [];
var tmp = {};

/*
tmp.id=2217;
tmp.longitude=69.299599;
tmp.latitude=41.319298;
tmp.owner="Isakov Ibrohim 5900922"
tmp.number="01 M 003667 Ibrohim"
tmp.name="Mers"
tmp.direction=248
tmp.speed=88
tmp.sat=88
tmp.time='2015-11-30 15:40:40'
tmp.ignition=1
tmp.gsmsignal=-1
tmp.battery66=13864
tmp.battery67=3627
tmp.seat=1000
tmp.batterylvl=-1
tmp.fuel=0
tmp.fuel_val=0
tmp.mu_additional='';
tmp.customization='a:1:{s:9:"fillcolor";s:7:"#FF0000";}'
tmp.additional='69:1;66:13864;70:281;67:3627;199:0;'
tmp.car_name='Mers 01 M 003667 Ibrohim'
tmp.imei=2217
tmp.formatted_time='2015-04-06 16:54:00'
tmp.dif=3942
tmp.online=false
tmp.action=2
*/
function setMapMode(pos)
{
    tmpData.push(pos);
    if (mon == null || mon == 'undefined') {
        mon = new Monitoring(map);
    }
    
    MonitoringTools.MonitoringInit([]);	
    mon.obj_array(pos, true);	
}

    setInterval(
function setMarkerPos() {
    $.ajax({
        url: "/positions",
        dataType: 'text',
        success: function(data) {
            var jpos = JSON.parse(data);
            jpos.Update[106206].customization='a:1:{s:9:"fillcolor";s:7:"#FF0000";}';
            jpos.Update[106206].additional='69:1;66:13864;70:281;67:3627;199:0;';
            jpos.Update[106206].action=2;
            jpos.Update[107699].action=2;
            var positions = [];
            positions.push(jpos.Update[106206]);
            positions.push(jpos.Update[107699]);
            console.log(positions);
            setMapMode(positions);
        }.bind(this),
        error: function(xhr, status, err) {
            console.err(err.toString());
        }.bind(this)
    });
} , 3000);
</script>
</head> 
<body onload="initialize()">
  <div id="map_canvas" style="width:100%; height:100%"></div>
</body>
</html>
